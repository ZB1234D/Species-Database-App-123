<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SBA Home</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#0b5c37" />
  <link rel="stylesheet" href="css/responsive.css" />

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #9acd6b;
      color: #000000;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding: 1rem 0;
    }

    .app-shell {
      background: #ffffff;
      width: 100%;
      max-width: 480px;
      min-height: 600px;
      margin: 0 auto;
      border-radius: 16px;
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.15);
      padding: 0;
      box-sizing: border-box;
    }

    .app-header {
      width: 100%;
      background-color: #0b5c37;
      padding: 1.5rem;
      border-radius: 16px 16px 0 0;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      box-sizing: border-box;
    }

    .header-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header-title {
      font-size: 1.6rem;
      font-weight: 700;
      color: #ffffff;
      margin: 0;
    }

    .header-actions {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .lang-btn, .sync-btn {
      background: white;
      color: #0b5c37;
      border: none;
      padding: 0.5rem 1rem;
      font-size: 1.1rem;
      font-weight: 600;
      border-radius: 10px;
      cursor: pointer;
      transition: 0.25s;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    .sync-btn:disabled {
      background: #e2e8f0;
      color: #94a3b8;
      cursor: not-allowed;
    }

    .sync-status-bar {
      background: rgba(255, 255, 255, 0.95);
      padding: 0.75rem;
      border-radius: 8px;
      display: none;
      flex-direction: column;
      gap: 0.5rem;
    }

    .sync-status-bar.active {
      display: flex;
    }

    .sync-progress {
      width: 100%;
      height: 8px;
      background: rgba(11, 92, 55, 0.2);
      border-radius: 4px;
      overflow: hidden;
    }

    .sync-progress-fill {
      height: 100%;
      background: #0b5c37;
      transition: width 0.3s ease;
    }

    .sync-status-text {
      font-size: 0.85rem;
      color: #0b5c37;
      font-weight: 600;
    }

    .search-bar {
      background: #ffffff;
      border-radius: 999px;
      padding: 0.75rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
    }

    .search-icon {
      font-size: 1.2rem;
      color: #475569;
    }

    .search-bar input {
      border: none;
      outline: none;
      width: 100%;
      font-size: 1rem;
    }

    .filter-carousel-container {
      padding: 0 1.5rem;
      margin-bottom: 1.5rem;
      position: relative;
    }

    .filter-carousel {
      display: flex;
      overflow-x: auto;
      scroll-behavior: smooth;
      scrollbar-width: none;
      gap: 0.75rem;
      padding: 0.5rem 0;
    }

    .filter-carousel::-webkit-scrollbar {
      display: none;
    }

    .filter-button {
      flex: 0 0 auto;
      padding: 0.625rem 1.25rem;
      border-radius: 999px;
      border: 1.5px solid #cbd5e1;
      background: #ffffff;
      color: #475569;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s ease;
    }

    .filter-button:hover {
      background: #f1f5f9;
    }

    .filter-button.active {
      background: #0f172a;
      color: #ffffff;
      border-color: #0f172a;
    }

    .container#species-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      padding: 1.5rem;
    }

    .species-list-card:hover {
      background-color: #8ac642;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
    }

    /* ========== FILTER OVERLAY - FIXED ========== */
    .filter-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      padding: 16px;
    }

    .filter-overlay.show {
      display: flex !important;
    }

    .filter-modal {
      background: white;
      width: 100%;
      max-width: 400px;
      border-radius: 16px;
      padding: 20px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }

    .filter-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid #e2e8f0;
    }

    .filter-title {
      font-size: 1.4rem;
      font-weight: 700;
      margin: 0;
      color: #0f172a;
    }

    .close-filter {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #f1f5f9;
      border: none;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 1.2rem;
      color: #64748b;
      transition: all 0.2s;
    }

    .close-filter:hover {
      background: #e2e8f0;
      color: #0f172a;
    }

    .filter-options {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .filter-option-btn {
      padding: 14px 18px;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      background: white;
      cursor: pointer;
      text-align: left;
      font-size: 1rem;
      font-weight: 500;
      color: #334155;
      transition: all 0.2s;
    }

    .filter-option-btn:hover {
      background: #f8fafc;
      border-color: #0b5c37;
      color: #0b5c37;
    }

    .filter-option-btn.selected {
      background: #0b5c37;
      border-color: #0b5c37;
      color: white;
    }

    /* ========== LANGUAGE OVERLAY ========== */
    .lang-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    .lang-overlay.show {
      display: flex !important;
    }

    .lang-modal {
      background: #ffffff;
      width: 92%;
      max-width: 440px;
      border-radius: 18px;
      padding: 20px;
      position: relative;
    }

    .lang-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin: 0 0 16px;
    }

    .lang-row {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px;
      border-radius: 10px;
      cursor: pointer;
    }

    .lang-row:hover {
      background: #f8fafc;
    }

    .lang-row.selected {
      background: #f1f5f9;
    }

    .close-overlay {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: #f1f5f9;
      border: none;
      cursor: pointer;
      font-size: 1rem;
    }
  </style>
</head>

<body>
  <div class="app-shell">
    <header class="app-header">
      <div class="header-top">
        <h1 class="header-title">Species Browser</h1>
        <div class="header-actions">
          <button class="sync-btn" id="syncBtn" title="Sync data">üîÑ</button>
          <button class="lang-btn" id="langBtn">EN</button>
        </div>
      </div>

      <!-- Sync Status Bar -->
      <div class="sync-status-bar" id="syncStatusBar">
        <div class="sync-progress">
          <div class="sync-progress-fill" id="syncProgressFill" style="width: 0%"></div>
        </div>
        <div class="sync-status-text" id="syncStatusText">Syncing...</div>
      </div>

      <div class="search-bar">
        <span class="search-icon">üîç</span>
        <input type="text" id="searchInput" placeholder="Search for a species..." />
      </div>
    </header>

    <!-- Filter Carousel -->
    <div class="filter-carousel-container">
      <div class="filter-carousel" id="filter-carousel">
        <button class="filter-button active" data-filter="all">All</button>
        <button class="filter-button" data-filter="a-z">A-Z</button>
        <button class="filter-button" data-filter="leaf-type">Leaf Type</button>
        <button class="filter-button" data-filter="fruit-type">Fruit Type</button>
      </div>
    </div>

    <!-- Species List -->
    <div class="container" id="species-list">
      <p style="text-align:center;">Loading...</p>
    </div>

    <!-- Filter Overlay -->
    <div class="filter-overlay" id="filterOverlay">
      <div class="filter-modal">
        <div class="filter-header">
          <h2 class="filter-title" id="filterTitle">Filter</h2>
          <button class="close-filter" id="closeFilterOverlay">‚úï</button>
        </div>
        <div class="filter-options" id="filterOptions"></div>
      </div>
    </div>

    <!-- Language Overlay -->
    <div class="lang-overlay" id="langOverlay">
      <div class="lang-modal">
        <button class="close-overlay" id="closeLangOverlay">‚úï</button>
        <h2 class="lang-title">Choose Language</h2>
        <div id="langList">
          <div class="lang-row selected" data-lang="en">
            <span>üá¨üáß</span> <span>English</span>
          </div>
          <div class="lang-row" data-lang="tet">
            <span>üáπüá±</span> <span>Tetum</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="scripts/specieslist.js"></script>
  <script src="scripts/filterCarousel.js"></script>
  <script src="scripts/sw-register.js"></script>
  <script src="scripts/specieslist.js" type="module"></script>
  

  <!-- Sync Button Logic -->
  <script type="module">
    import { syncBundle } from "./scripts/bundleSync.js";
    import { metaGet } from "./scripts/db.js";

    const syncBtn = document.getElementById("syncBtn");
    const syncStatusBar = document.getElementById("syncStatusBar");
    const syncProgressFill = document.getElementById("syncProgressFill");
    const syncStatusText = document.getElementById("syncStatusText");

    let isSyncing = false;

    function updateUI(data) {
      if (data.phase === "version") {
        syncStatusText.textContent = data.message;
      } else if (data.phase === "media") {
        const pct = (data.current / data.total) * 100;
        syncProgressFill.style.width = pct + "%";
        syncStatusText.textContent = data.message;
      } else if (data.phase === "done") {
        syncProgressFill.style.width = "100%";
        syncStatusText.textContent = "‚úÖ " + data.message;
        setTimeout(() => {
          syncStatusBar.classList.remove("active");
          location.reload();
        }, 1500);
      }
    }

    async function startSync() {
      if (isSyncing) return;
      isSyncing = true;
      syncBtn.disabled = true;
      syncStatusBar.classList.add("active");
      syncProgressFill.style.width = "0%";

      try {
        await syncBundle({ onProgress: updateUI });
      } catch (err) {
        console.error("[Sync] Error:", err);
        syncStatusText.textContent = "‚ùå Error: " + err.message;
        setTimeout(() => syncStatusBar.classList.remove("active"), 3000);
      } finally {
        isSyncing = false;
        syncBtn.disabled = false;
      }
    }

    syncBtn.addEventListener("click", startSync);
  </script>

  <!-- Language Switcher -->
  <script>
    const langBtn = document.getElementById("langBtn");
    const langOverlay = document.getElementById("langOverlay");
    const closeLangOverlay = document.getElementById("closeLangOverlay");

    langBtn.addEventListener("click", () => langOverlay.classList.add("show"));
    closeLangOverlay.addEventListener("click", () => langOverlay.classList.remove("show"));
    langOverlay.addEventListener("click", (e) => {
      if (e.target === langOverlay) langOverlay.classList.remove("show");
    });

    document.querySelectorAll(".lang-row").forEach(row => {
      row.addEventListener("click", () => {
        const lang = row.dataset.lang;
        localStorage.setItem("app_language", lang);
        langBtn.textContent = lang.toUpperCase();
        langOverlay.classList.remove("show");
        location.reload();
      });
    });

    const savedLang = localStorage.getItem("app_language") || "en";
    langBtn.textContent = savedLang.toUpperCase();
  </script>

  <!-- Filter Logic - FIXED -->
  <script>
    const filterOverlay = document.getElementById("filterOverlay");
    const closeFilterOverlay = document.getElementById("closeFilterOverlay");
    const filterTitle = document.getElementById("filterTitle");
    const filterOptions = document.getElementById("filterOptions");

    let activeFilters = { leafType: null, fruitType: null };

    const leafTypes = [
      "Simple", 
      "Pinnately compound (single)", 
      "Pinnately compound (double)", 
      "Pinnately compound (triple)",
      "Palmately compound"
    ];
    
    const fruitTypes = [
      "Drupe", 
      "Capsule", 
      "Follicle", 
      "Pod",
      "Berry",
      "Nut"
    ];

    const filterConfigs = {
      "a-z": {
        title: "Sort Alphabetically",
        options: [
          { label: "A ‚Üí Z", action: () => sortSpecies("az") },
          { label: "Z ‚Üí A", action: () => sortSpecies("za") },
        ],
      },
      "leaf-type": {
        title: "Leaf Type",
        options: leafTypes.map(t => ({ label: t, value: t, type: "leaf-type" })),
      },
      "fruit-type": {
        title: "Fruit Type",
        options: fruitTypes.map(t => ({ label: t, value: t, type: "fruit-type" })),
      },
    };

    function showFilterOverlay() {
      filterOverlay.classList.add("show");
    }

    function hideFilterOverlay() {
      filterOverlay.classList.remove("show");
    }

    function applyFilters() {
      if (!window.loadedSpeciesData) return;
      let filtered = [...window.loadedSpeciesData];

      if (activeFilters.leafType) {
        filtered = filtered.filter(s => 
          (s.leaf_type || '').toLowerCase().includes(activeFilters.leafType.toLowerCase())
        );
      }
      if (activeFilters.fruitType) {
        filtered = filtered.filter(s => 
          (s.fruit_type || '').toLowerCase().includes(activeFilters.fruitType.toLowerCase())
        );
      }

      const query = document.getElementById("searchInput")?.value.toLowerCase().trim() || "";
      if (query) {
        filtered = filtered.filter(s =>
          (s.scientific_name || '').toLowerCase().includes(query) ||
          (s.common_name || '').toLowerCase().includes(query)
        );
      }

      window.renderSpecies(filtered);
    }

    window.applyFilters = applyFilters;

    function sortSpecies(dir) {
      if (!window.loadedSpeciesData) return;
      const sorted = [...window.loadedSpeciesData].sort((a, b) => {
        const nameA = (a.scientific_name || '').toLowerCase();
        const nameB = (b.scientific_name || '').toLowerCase();
        return dir === "az" ? nameA.localeCompare(nameB) : nameB.localeCompare(nameA);
      });
      window.renderSpecies(sorted);
      hideFilterOverlay();
    }

    // Filter button click handlers
    document.querySelectorAll(".filter-button").forEach(btn => {
      btn.addEventListener("click", () => {
        const key = btn.dataset.filter;
        
        console.log("[Filter] Clicked:", key);

        // Reset active state
        document.querySelectorAll(".filter-button").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");

        if (key === "all") {
          activeFilters = { leafType: null, fruitType: null };
          if (window.loadedSpeciesData) window.renderSpecies(window.loadedSpeciesData);
          return;
        }

        const config = filterConfigs[key];
        if (!config) {
          console.warn("[Filter] No config for:", key);
          return;
        }

        // Set title
        filterTitle.textContent = config.title;
        
        // Clear and populate options
        filterOptions.innerHTML = "";

        config.options.forEach(opt => {
          const optBtn = document.createElement("button");
          optBtn.className = "filter-option-btn";
          optBtn.textContent = opt.label;
          
          // Check if currently selected
          if (opt.type === "leaf-type" && activeFilters.leafType === opt.value) {
            optBtn.classList.add("selected");
          } else if (opt.type === "fruit-type" && activeFilters.fruitType === opt.value) {
            optBtn.classList.add("selected");
          }

          optBtn.onclick = () => {
            if (opt.action) {
              opt.action();
            } else {
              if (opt.type === "leaf-type") {
                activeFilters.leafType = activeFilters.leafType === opt.value ? null : opt.value;
              } else if (opt.type === "fruit-type") {
                activeFilters.fruitType = activeFilters.fruitType === opt.value ? null : opt.value;
              }
              applyFilters();
              hideFilterOverlay();
            }
          };

          filterOptions.appendChild(optBtn);
        });

        // Show overlay
        showFilterOverlay();
      });
    });

    // Close handlers
    closeFilterOverlay.addEventListener("click", hideFilterOverlay);
    filterOverlay.addEventListener("click", (e) => {
      if (e.target === filterOverlay) hideFilterOverlay();
    });

    // Escape key to close
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        hideFilterOverlay();
        langOverlay.classList.remove("show");
      }
    });

    console.log("[Filter] Logic initialized");
  </script>
</body>
</html>